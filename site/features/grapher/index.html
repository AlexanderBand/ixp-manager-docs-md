<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Grapher - IXP Manager Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Grapher";
    var mkdocs_page_input_path = "features/grapher.md";
    var mkdocs_page_url = "/features/grapher/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> IXP Manager Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Installation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../install/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../install/automated-script/">Automated Script</a>
                </li>
                <li class="">
                    
    <a class="" href="../../install/maint-mode/">Maintenance Mode</a>
                </li>
                <li class="">
                    
    <a class="" href="../../install/manually/">Manual Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../install/upgrading/">Upgrading</a>
                </li>
                <li class="">
                    
    <a class="" href="../../install/upgrade-v3/">Upgrade From v3</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Features</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../routers/">AS112</a>
                </li>
                <li class="">
                    
    <a class="" href="../contact-groups/">Contact Groups</a>
                </li>
                <li class="">
                    
    <a class="" href="../patch-panels/">Cross Connects</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Grapher</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#grapher">Grapher</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#configuration">Configuration</a></li>
        
            <li><a class="toctree-l4" href="#grapher-backends">Grapher Backends</a></li>
        
            <li><a class="toctree-l4" href="#backend-mrtg">Backend: MRTG</a></li>
        
            <li><a class="toctree-l4" href="#backend-sflow">Backend: sflow</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../helpdesk/">Helpdesk Integration</a>
                </li>
                <li class="">
                    
    <a class="" href="../routers/">IRRDB</a>
                </li>
                <li class="">
                    
    <a class="" href="../layer2-addresses/">Layer2 Addresses</a>
                </li>
                <li class="">
                    
    <a class="" href="../looking-glass/">Looking Glass</a>
                </li>
                <li class="">
                    
    <a class="" href="../layer2-addresses/">MAC Addresses</a>
                </li>
                <li class="">
                    
    <a class="" href="../mailing-lists/">Mailing List Management</a>
                </li>
                <li class="">
                    
    <a class="" href="../patch-panels/">Patch Panels</a>
                </li>
                <li class="">
                    
    <a class="" href="../reseller/">Reseller Functionality</a>
                </li>
                <li class="">
                    
    <a class="" href="../routers/">Route Collector</a>
                </li>
                <li class="">
                    
    <a class="" href="../routers/">Route Server</a>
                </li>
                <li class="">
                    
    <a class="" href="../routers/">Routers</a>
                </li>
                <li class="">
                    
    <a class="" href="../skinning/">Skinning</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Development</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../dev/api/">API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/ci/">Continuous Integration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/docs/">Documentation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/grapher/">Grapher</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/helpders/">Helpers</a>
                </li>
                <li class="">
                    
    <a class="" href="../../dev/vagrant/">Vagrant</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">IXP Manager Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Features &raquo;</li>
        
      
    
    <li>Grapher</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/inex/ixp-manager-docs-md/edit/master/docs/features/grapher.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="grapher">Grapher</h1>
<p>The biggest new feature available at launch in IXP Manager v4 is a new graphing system called <em>Grapher</em>.</p>
<p><em>Grapher</em> is a complete rewrite of all previous graphing code and includes:</p>
<ul>
<li>API access to graphs and graph statistics</li>
<li>multiple backends (such as MRTG, sflow) with dynamic resolution of appropriate backend</li>
<li>configuration generation where required</li>
<li>consistent and flexible OOP design</li>
</ul>
<p>To date, we've developed three reference backend implementations:</p>
<ol>
<li><code>dummy</code> - a dummy grapher that just provides a placeholder graph for all possible graph types;</li>
<li><code>mrtg</code> - MRTG graphing using either the log or rrd backend. Use cases for MRTG are L2 interface statistics for bits / packets / errors / discards / broadcasts per second. Aggregate graphs for customer LAGs, overall customer traffic, all traffic over a switch / infrastructure / the entire IXP are all supported.</li>
<li><code>sflow</code> - while the MRTG backend looks at layer 2 statistics, sflow is used to provide layer 3 statistics such as per protocol (IPv4/6) graphs and peer to peer graphs.</li>
</ol>
<p>In a typical production environment, you'd implement both MRTG and sflow to provide the complete set of features.</p>
<h2 id="configuration">Configuration</h2>
<p>There is only a handful of configuration options required and these can be seen with documentation in <a href="https://github.com/inex/IXP-Manager/blob/master/config/grapher.php"><code>config/grapher.php</code></a> (remember to put your own local changes in <code>.env</code> rather than editing this file directly).</p>
<p>The only global (non-backend specific) options are:</p>
<ul>
<li><code>backend</code> - in a typical production environment this would be <code>"mrtg|sflow"</code> which means try the MRTG backend first and then sflow. We ship with this set as <code>"dummy"</code> so you can see sample graphs working out of the box.</li>
<li><code>cache</code> - as the industry standard is to graph at 5min intervals, the cache settings do not regenerate / reload / reprocess log / rrd / image files if we have cached them and they are less than 5mins old. This is enabled by default which is the recommended setting.</li>
</ul>
<p>Backend specific configuration and set-up instructions can be found in their own sections.</p>
<h2 id="grapher-backends">Grapher Backends</h2>
<h2 id="backend-mrtg">Backend: MRTG</h2>
<p>MRTG is a particularly efficient SNMP poller as, irrespective of how many times an interface is referenced for different graphs, it is only polled once per run.</p>
<p>Per-second graphs are generated for bits, packets, errors, discards and broadcasts at 5min intervals. IXP Manager's Grapher system can use MRTG to poll switches and create traffic graphs for:</p>
<ul>
<li><strong>Aggregate IXP and Infrastructure Graphs</strong></li>
</ul>
<p>The MRTG script creates aggregate graphs for the entire IXP as well as per-infrastructure graphs. These graphs are available from the <em>Statistics</em> menu under <em>Overall Peering Graphs</em>. Also, the graphs on the admin dashboard are the monthly versions of these and will appear on the dashboard when configured as above.</p>
<ul>
<li><strong>Switch Aggregate Graphs</strong></li>
</ul>
<p>These are defined and built automatically from the switches you have defined. These graphs are the aggregate of all peering ports. These graphs are available from the <em>Statistics</em> menu under <em>Switch Aggregate Graphs</em>.</p>
<ul>
<li><strong>Inter-Switch / Trunk Graphs</strong></li>
</ul>
<p>IXP Manager does not currently support a frontend means of creating these definitions (but, as of March 2017, it is being worked on). For now, we do it manually via the <a href="https://github.com/inex/IXP-Manager/wiki/MRTG---Traffic-Graphs#inter-switch--trunk-graphs">IXP Manager v3 way</a>.</p>
<p>These graphs will be available in the <em>Statistics</em> menu under <em>Inter-Switch / PoP Graphs</em>.</p>
<ul>
<li><strong>Customer Graphs</strong></li>
</ul>
<p>MRTG creates per port, per LAG and aggregate graphs for each member / customer.</p>
<h3 id="mrtg-setup-and-configuration">MRTG Setup and Configuration</h3>
<p>You need to install some basic packages for MRTG to work - on Ubuntu for example, install:</p>
<div class="highlight"><pre>apt-get install libconfig-general-perl libnetaddr-ip-perl mrtg
</pre></div>


<p>You also need a folder to store all MRTG files. For example:</p>
<div class="highlight"><pre>mkdir -p /srv/mrtg
</pre></div>


<p>In your `.env, you need to set the following options:</p>
<div class="highlight"><pre># the database type to use - either log or rrd
GRAPHER_BACKEND_MRTG_DBTYPE=&quot;rrd&quot;
# where to store log/rrd/png files as created above. This is from the perspective
# of the mrtg daemon so should also be local
GRAPHER_BACKEND_MRTG_WORKDIR=&quot;/tmp&quot;
# where to find the WORKDIR above from IXP Manager&#39;s perspective. This can be a
# local directory or a URL to remote web server
GRAPHER_BACKEND_MRTG_LOGDIR=&quot;http://collector.example.com/mrtg&quot;
</pre></div>


<p>You can now generate a MRTG configuration by executing a command such as:</p>
<div class="highlight"><pre><span class="c"># output to stdout:</span>
./artisan grapher:generate-configuration -B mrtg
<span class="c"># output to a named file</span>
./artisan grapher:generate-configuration -B mrtg -O /tmp/mrtg.cfg.candidate
</pre></div>


<p>You could also combine a syntax check before putting the resultant file live. Here's a complete example that could be run via cron:</p>
<div class="highlight"><pre><span class="c">#! /bin/sh</span>

<span class="nv">APPLICATION_PATH</span><span class="o">=</span>/srv/ixp

<span class="c"># Synchronise configuration files</span>
<span class="si">${</span><span class="nv">APPLICATION_PATH</span><span class="si">}</span>/artisan grapher:generate-configuration -B mrtg -O /tmp/mrtg.cfg.candidate

/usr/bin/mrtg --check /tmp/mrtg.cfg.candidate                 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> /bin/mv /tmp/mrtg.cfg.candidate /etc/mrtg/mrtg.cfg
</pre></div>


<p>If your MRTG collector is on a different server, you could use a script such as the following to safely update MRTG:</p>
<div class="highlight"><pre><span class="c">#! /bin/bash</span>

curl --fail -s -H <span class="s2">&quot;X-IXP-Manager-API-Key: your_api_key&quot;</span> <span class="se">\</span>
    https://ixp.example.com/api/v4/grapher/mrtg-config &gt;/etc/mrtg/mrtg.cfg.<span class="nv">$$</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;WARNING: COULD NOT FETCH UP TO DATE MRTG CONFIGURATION!&quot;</span>
    <span class="nb">exit</span> -1
<span class="k">fi</span>

<span class="nb">cd</span> /etc/mrtg

cat mrtg.cfg    <span class="p">|</span> egrep -v <span class="s1">&#39;^#.*$&#39;</span> <span class="p">|</span> egrep -v <span class="s1">&#39;^[ ]+Based on configuration last generated by.*$&#39;</span> &gt;mrtg.cfg.filtered
cat mrtg.cfg.<span class="nv">$$</span> <span class="p">|</span> egrep -v <span class="s1">&#39;^#.*$&#39;</span> <span class="p">|</span> egrep -v <span class="s1">&#39;^[ ]+Based on configuration last generated by.*$&#39;</span> &gt;mrtg.cfg.<span class="nv">$$</span>.filtered
diff mrtg.cfg.filtered mrtg.cfg.<span class="nv">$$</span>.filtered &gt;/dev/null
<span class="nv">DIFF</span><span class="o">=</span><span class="nv">$?</span>

rm mrtg.cfg.filtered
rm mrtg.cfg.<span class="nv">$$</span>.filtered

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$DIFF</span> -eq <span class="m">0</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    rm mrtg.cfg.<span class="nv">$$</span>
    <span class="nb">exit </span>0
<span class="k">fi</span>

/usr/local/bin/mrtg --check /etc/mrtg/mrtg.cfg.<span class="nv">$$</span>                 <span class="se">\</span>
    <span class="o">&amp;&amp;</span> /bin/mv /etc/mrtg/mrtg.cfg.<span class="nv">$$</span> /etc/mrtg/mrtg.cfg <span class="se">\</span>
    <span class="o">&amp;&amp;</span> /etc/rc.d/mrtg_daemon restart &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
</pre></div>


<p>Note that our header template starts MRTG as a daemon. On FreeBSD, MRTG comes with an initd script by default and you can kick it off on boot with something like the following in rc.conf:</p>
<div class="highlight"><pre>mrtg_daemon_enable=&quot;YES&quot;
mrtg_daemon_config=&quot;/etc/mrtg/mrtg.cfg&quot;
</pre></div>


<p>However, on Ubuntu it does not but it comes with a /etc/cron.d/mrtg file which kicks it off every five minutes (it will daemonise the first time and further cron jobs will have no effect). If you use this method, you will need to have your periodic update script restart / stop the daemon when the configuration changes (as demonstrated in the above script).</p>
<p>To start and stop it via standard initd scripts on Ubuntu, use <a href="https://github.com/inex/IXP-Manager/blob/master/tools/runtime/mrtg/ubuntu-mrtg-initd">an initd script such as this</a>  (<a href="http://www.iceflatline.com/2009/08/how-to-install-and-configure-mrtg-on-ubuntu-server/">source</a>:</p>
<div class="highlight"><pre>cp $APPLICATION_PATH/tools/runtime/mrtg/ubuntu-mrtg-initd /etc/init.d/mrtg
chmod +x /etc/init.d/mrtg
update-rc.d mrtg defaults
/etc/init.d/mrtg start
</pre></div>


<p>Remember to disable the default cron job for MRTG on Ubuntu!</p>
<h3 id="customising-the-configuration">Customising the Configuration</h3>
<p>An example of how to customise the MRTG configuration <a href="../skinning/">can be found in the skinning documenation</a>.</p>
<h3 id="inserting-traffic-data-into-the-database-reporting-emails">Inserting Traffic Data Into the Database / Reporting Emails</h3>
<p>The MRTG backend inserts daily summaries into MySQL for reporting. An example crontab for this is:</p>
<div class="highlight"><pre>0 2   * * *   www-data        /srv/ixpmanager/artisan grapher:upload-stats-to-db

0 4   * * *   www-data        /srv/ixpmanager/artisan grapher:email-traffic-deltas --stddev=1.5 -v user1@example.com,user2@example.com

30 10 * * tue www-data        /srv/ixpmanager/artisan grapher:email-port-utilisations --threshold=80 ops@inex.ie,barry.rhodes@inex.ie,eileen@inex.ie

31 10 * * *   www-data        /srv/ixpmanager/artisan grapher:email-ports-with-counts --discards ops@inex.ie

32 10 * * *   www-data        /srv/ixpmanager/artisan grapher:email-ports-with-counts --errors ops@inex.ie
</pre></div>


<p>which, in the order above, do:</p>
<ol>
<li>Once per day, upload <em>yesterday's</em> summary of MRTG statistics into the database.</li>
<li>Email a report of members whose average traffic has changed by more than 1.5 times their standard deviation to <code>user1@example.com</code> and <code>user2@example.com</code>.</li>
<li>Email a report of all ports with &gt;=80% utilisation yesterday.</li>
<li>Email a report of all ports with a non-zero discard count yesterday.</li>
<li>Email a report of all ports with a non-zero error count yesterday.</li>
</ol>
<h2 id="backend-sflow">Backend: sflow</h2>
<p>Documentation on sflow is being prepared for v4 but the <a href="https://github.com/inex/IXP-Manager/wiki/Installing-Sflow-Support">v4 documentation is stail available here</a>.</p>
<p>The previous version of IXP Manager (&lt;4) used a script called <code>sflow-graph.php</code> which was installed on the sflow server to create graphs on demand. IXP Manager v4 does not use this but pulls the required RRD files directly.</p>
<p>If you have these on the same server (not typically recommended), then set the path accordingly in <code>.env</code>:</p>
<div class="highlight"><pre>GRAPHER_BACKEND_SFLOW_ROOT=&quot;/srv/ixpmatrix&quot;
</pre></div>


<p>If you have implemented this via a web server on the sflow server (as we typically do at INEX), then you need to expose the RRD data directory to IXP Manager using an Apache config such as:</p>
<div class="highlight"><pre>Alias /grapher-sflow /srv/ixpmatrix

&lt;Directory &quot;/srv/ixpmatrix&quot;&gt;
    Options None
    AllowOverride None
    &lt;RequireAny&gt;
            Require ip 192.0.2.0/24
            Require ip 2001:db8::/32
    &lt;/RequireAny&gt;
&lt;/Directory&gt;
</pre></div>


<p>and update <code>.env</code> for this with something like:</p>
<div class="highlight"><pre>GRAPHER_BACKEND_SFLOW_ROOT=&quot;http://www.example.com/grapher-sflow&quot;
</pre></div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../helpdesk/" class="btn btn-neutral float-right" title="Helpdesk Integration">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../patch-panels/" class="btn btn-neutral" title="Cross Connects"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>&copy; 2017, Internet Neutral Exchange Association Company Limited by Guarantee (INEX).<br><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>&nbsp;This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/inex/ixp-manager-docs-md" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../patch-panels/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../helpdesk/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
